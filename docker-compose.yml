---
version: '3.8'
services:
  db:
    image:  mysql:8.0
    container_name: refrigerator-db

    environment:
      MYSQL_DATABASE: refrigerator_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    
    volumes:
      - mysql-data:/var/lib/mysql

    healthcheck:
      test: ["CMD","mysqladmin","ping","-h","localhost","-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  app:
    container_name: refrigerator_app
    build:
      context: ./backend
      dockerfile: Dockerfile

    depends_on:
      db:
        condition: service_healthy

    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/refrigerator_db?useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=password

  frontend:
    container_name: refrigerator_frontend
    depends_on:
      - app

volumes:
  mysql-data: